<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Dashboard Data</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .data { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        button { padding: 10px 20px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a87; }
        .stats { display: flex; gap: 20px; flex-wrap: wrap; }
        .stat-card { background: #e7f3ff; padding: 15px; border-radius: 5px; min-width: 150px; }
        .stat-value { font-size: 24px; font-weight: bold; color: #007cba; }
        .stat-label { font-size: 14px; color: #666; }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore-compat.js"></script>
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
</head>
<body>
    <h1>RSVP Dashboard Data Debug Tool</h1>
    
    <div class="section">
        <h2>Quick Actions</h2>
        <button onclick="fetchGuestListData()">Fetch Guest List Data</button>
        <button onclick="fetchSubmissionsData()">Fetch Submissions Data</button>
        <button onclick="calculateStats()">Calculate Statistics</button>
        <button onclick="clearOutput()">Clear Output</button>
    </div>

    <div class="section">
        <h2>Statistics Summary</h2>
        <div id="stats-summary" class="stats">
            <div class="stat-card">
                <div class="stat-value" id="total-guests">-</div>
                <div class="stat-label">Total Guests</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="responded-guests">-</div>
                <div class="stat-label">Responded</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="attending-guests">-</div>
                <div class="stat-label">Attending</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="declining-guests">-</div>
                <div class="stat-label">Declining</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="response-rate">-</div>
                <div class="stat-label">Response Rate</div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Debug Output</h2>
        <div id="output"></div>
    </div>

    <script>
        let db;
        let guestListData = [];
        let submissionsData = [];

        // Initialize Firebase
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof firebase !== 'undefined') {
                db = firebase.firestore();
                log('Firebase initialized successfully');
            } else {
                log('ERROR: Firebase not available');
            }
        });

        function log(message) {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `<div class="data">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        async function fetchGuestListData() {
            if (!db) {
                log('ERROR: Database not initialized');
                return;
            }

            try {
                log('Fetching guest list data...');
                const querySnapshot = await db.collection('guestList').get();
                
                guestListData = querySnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        name: data.name || '',
                        hasResponded: data.hasResponded || false,
                        response: data.response || '',
                        actualGuestCount: data.actualGuestCount || 0,
                        ...data
                    };
                });

                log(`Found ${guestListData.length} guests in guest list`);
                
                // Show sample data
                if (guestListData.length > 0) {
                    log('Sample guest data:');
                    log('<pre>' + JSON.stringify(guestListData.slice(0, 3), null, 2) + '</pre>');
                }

                // Show response breakdown
                const responded = guestListData.filter(g => g.hasResponded);
                const attending = guestListData.filter(g => g.hasResponded && g.response === 'attending');
                const declining = guestListData.filter(g => g.hasResponded && g.response === 'declined');

                log(`Response breakdown:`);
                log(`- Total guests: ${guestListData.length}`);
                log(`- Responded: ${responded.length}`);
                log(`- Attending: ${attending.length}`);
                log(`- Declining: ${declining.length}`);

                calculateStats();
            } catch (error) {
                log('ERROR fetching guest list: ' + error.message);
                console.error(error);
            }
        }

        async function fetchSubmissionsData() {
            if (!db) {
                log('ERROR: Database not initialized');
                return;
            }

            try {
                log('Fetching submissions data...');
                const querySnapshot = await db.collection('sheetRsvps').orderBy('submittedAt', 'desc').get();
                
                submissionsData = querySnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        name: data.name || '',
                        attending: data.attending || '',
                        adultCount: data.adultCount || 0,
                        childCount: data.childCount || 0,
                        guestCount: data.guestCount || 0,
                        ...data
                    };
                });

                log(`Found ${submissionsData.length} submissions`);
                
                // Show sample data
                if (submissionsData.length > 0) {
                    log('Sample submission data:');
                    log('<pre>' + JSON.stringify(submissionsData.slice(0, 3), null, 2) + '</pre>');
                }

                // Show attendance breakdown
                const attending = submissionsData.filter(s => s.attending === 'yes');
                const declining = submissionsData.filter(s => s.attending === 'no');
                const totalAdults = attending.reduce((sum, s) => sum + (s.adultCount || 0), 0);
                const totalChildren = attending.reduce((sum, s) => sum + (s.childCount || 0), 0);

                log(`Submissions breakdown:`);
                log(`- Total submissions: ${submissionsData.length}`);
                log(`- Attending: ${attending.length}`);
                log(`- Declining: ${declining.length}`);
                log(`- Total adults attending: ${totalAdults}`);
                log(`- Total children attending: ${totalChildren}`);

            } catch (error) {
                log('ERROR fetching submissions: ' + error.message);
                console.error(error);
            }
        }

        function calculateStats() {
            if (guestListData.length === 0) {
                log('No guest list data available. Fetch guest list first.');
                return;
            }

            const totalGuests = guestListData.length;
            const respondedGuests = guestListData.filter(g => g.hasResponded).length;
            const attendingGuests = guestListData.filter(g => g.hasResponded && g.response === 'attending').length;
            const decliningGuests = guestListData.filter(g => g.hasResponded && g.response === 'declined').length;
            const responseRate = totalGuests > 0 ? Math.round((respondedGuests / totalGuests) * 100) : 0;

            // Update UI
            document.getElementById('total-guests').textContent = totalGuests;
            document.getElementById('responded-guests').textContent = respondedGuests;
            document.getElementById('attending-guests').textContent = attendingGuests;
            document.getElementById('declining-guests').textContent = decliningGuests;
            document.getElementById('response-rate').textContent = responseRate + '%';

            log('=== CALCULATED STATISTICS ===');
            log(`Total Guests: ${totalGuests}`);
            log(`Responded: ${respondedGuests} (${responseRate}%)`);
            log(`Not Responded: ${totalGuests - respondedGuests}`);
            log(`Attending: ${attendingGuests}`);
            log(`Declining: ${decliningGuests}`);
            log('==============================');
        }
    </script>
</body>
</html>
